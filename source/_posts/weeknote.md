---
title: NodeJS中的内存控制
date: 2020-11-21 19:29:45
tags: Node.js
---

# NodeJS中的内存控制
  NodeJs的成功离不开V8，Ryan Dahl当时选择V8作为Node的JavaScript脚本引擎，是因为在第三次浏览器大战中
Chrome浏览器以其优异的性能成为焦点，这当然得益于V8。V8出现以后，改变了JavaScript性能低下的问题，再结合事件驱动，无阻塞的Node使得用JavaScript写高性能的服务器成为了可能。

  Node在JavaScript的执行上直接受益于V8,可以随着V8的升级享受到性能的提升或新的语言特性(ES5,ES6+)等,但
同时也受到了V8的一些限制,这就是下面要讲的内存限制。

## V8的内存限制
  一般的后端语言中，在基本的内存使用上没有什么限制，然而Node中通过JavaScript使用内存时就会发现只能使用部分存。**64位系统下约1.4GB，32位系统下约位0.7GB** 这就导致Node无法直接操作大内存对象，就算物理内存很大。这样单线程的Node就无法充分的利用服务器资源。

  造成这个问题的罪魁祸首是V8，因为Node基于V8构建，所以在Node中使用JavaScript对象基本上都是通过V8自己的方式来进行分配和管理的。

## V8的对象分配
  在V8中，所有的JavaScript对象都是通过堆来进行分配的。
``` javascript
$ node 
> process.memoryUsage();
{
  rss: 24059904,
  heapTotal: 9682944, // 已申请到的堆内存
  heapUsed: 5816184, // 已使用的堆内存
  external: 8737
}
```

当我们在代码中声明变量并赋值时，所使用对象的内存就分配在堆中。如果已申请堆堆空闲内存不够用时将继续申请堆内存，一直到堆的大小超过V8的限制为止。

为什么V8要限制堆的大小？
1. 因为起初V8是为浏览器设计，不太可能遇到用大量内存的场景，对于网页来说V8最初的堆内存是
完全够用的。
